name: Build package
on:
  push:
    branches:
      - test-actions
jobs:
  main:
    name: Release
    runs-on: ubuntu-latest
    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # - name: Lint Commit Message
      #   working-directory: commit-lint
      #   run: |
      #     yarn init -y
      #     yarn add -D @commitlint/config-conventional
      #     echo $(git log -1 --pretty=format:"%s") | yarn commitlint

      # - name: Create .npmrc
      #   run: |
      #     cat << EOF > "$HOME/.npmrc"
      #       @nestjs-pact:registry=https://registry.npmjs.org/
      #       //registry.npmjs.org/:_authToken=$NPM_TOKEN
      #       FirstName LastName (omer.mroadd@gmail.com, omer.mroadd@gmail.com)=true
      #       email=omer.mroadd@gmail.com
      #       always-auth=true
      #     EOF
      #   env:
      #     NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: 14.x

      - name: Install Dependencies
        run: yarn install

      # - name: Bootstrap Packages
      #   run: yarn lerna bootstrap

      - name: Build
        run: yarn build

      - name: Test
        run: yarn test

      - name: Release
        run: yarn publish --new-version $(npx -c 'echo "$npm_package_version"')

      - name: Tag release
        run: |
          git tag $(npx -c 'echo "$npm_package_version"')
          git push --tags --no-verify    


      # - name: Release
      #   id: changesets
      #   uses: changesets/action@v1
      #   with:
      #     publish: yarn publish
      #     commit: "chore: version packages"
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
